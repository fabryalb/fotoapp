<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aggiungi foto - Galleria</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <h1>Aggiungi nuove foto</h1>
        <nav>
            <a href="{{ url_for('index') }}" class="btn">Indietro</a>
        </nav>
    </header>

    <div class="flash-messages">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="flash">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <main class="upload-form">
        <form method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="titolo">Titolo:</label>
                <input type="text" id="titolo" name="titolo" placeholder="Titolo delle foto">
            </div>

            <div class="form-group">
                <label for="descrizione">Descrizione:</label>
                <textarea id="descrizione" name="descrizione" placeholder="Descrizione delle foto"></textarea>
            </div>

            <div class="form-group">
                <label for="data">Data:</label>
                <input type="date" id="data" name="data" value="{{ oggi }}">
            </div>

            <!-- SEZIONE CATEGORIE MIGLIORATA -->
            <div class="form-group">
                <label>Seleziona dove inserire le foto:</label>
                
                <div class="category-selection-tabs">
                    <div class="tab-buttons">
                        <button type="button" class="tab-btn active" data-tab="tab-esistente">
                            üìÅ Categoria esistente
                        </button>
                        <button type="button" class="tab-btn" data-tab="tab-nuova-principale">
                            ‚ûï Nuova categoria principale
                        </button>
                        <button type="button" class="tab-btn" data-tab="tab-nuova-sotto">
                            üìÇ Nuova sottocategoria
                        </button>
                    </div>
                    
                    <!-- Tab 1: Categoria esistente -->
                    <div class="tab-content active" id="tab-esistente">
                        <input type="hidden" name="tipo_categoria" value="esistente">
                        
                        <div class="explanation-box">
                            <p>üìå Inserisci le foto in una categoria che esiste gi√†</p>
                        </div>
                        
                        <label for="categoria_esistente">Seleziona categoria:</label>
                        <select id="categoria_esistente" name="categoria_esistente" class="full-width">
                            <option value="">-- Seleziona dove inserire le foto --</option>
                            {% for cat_princ, sottocategorie in struttura_categorie.items() %}
                                <optgroup label="üìÅ {{ cat_princ }}">
                                    <!-- Categoria principale -->
                                    <option value="{{ cat_princ }}">
                                        üè† {{ cat_princ }} (principale)
                                    </option>
                                    <!-- Sottocategorie -->
                                    {% for subcat in sottocategorie %}
                                        <option value="{{ cat_princ }}/{{ subcat }}">
                                            üìÇ {{ cat_princ }} ‚Üí {{ subcat }}
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                            
                            <!-- Categorie semplici (senza sottocategorie) -->
                            {% set categorie_semplici = [] %}
                            {% for categoria in categorie %}
                                {% if '/' not in categoria and '>' not in categoria %}
                                    {% set _ = categorie_semplici.append(categoria) %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if categorie_semplici %}
                                <optgroup label="üìã Categorie semplici">
                                    {% for categoria in categorie_semplici %}
                                        <option value="{{ categoria }}">üè∑Ô∏è {{ categoria }}</option>
                                    {% endfor %}
                                </optgroup>
                            {% endif %}
                        </select>
                    </div>
                    
                    <!-- Tab 2: Nuova categoria principale (livello 1) -->
                    <div class="tab-content" id="tab-nuova-principale">
                        <input type="hidden" name="tipo_categoria" value="nuova_principale" disabled>
                        
                        <div class="explanation-box">
                            <p>‚ûï Crea una nuova categoria di <strong>primo livello</strong> (come "maglie toro", "max", ecc.)</p>
                            <small>Esempio: "maglie juventus", "ricordi famiglia", "viaggi 2025"</small>
                        </div>
                        
                        <label for="nuova_categoria_principale">Nome nuova categoria principale:</label>
                        <input type="text" 
                               id="nuova_categoria_principale" 
                               name="nuova_categoria_principale" 
                               placeholder="Es: maglie milan, viaggi estero, eventi speciali" 
                               class="full-width" 
                               disabled>
                        
                        <div class="preview-box" id="preview-principale" style="display:none;">
                            <strong>üèóÔ∏è Anteprima:</strong>
                            <div class="category-preview">
                                <span id="preview-principale-text"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 3: Nuova sottocategoria (livello 2) -->
                    <div class="tab-content" id="tab-nuova-sotto">
                        <input type="hidden" name="tipo_categoria" value="nuova_sotto" disabled>
                        
                        <div class="explanation-box">
                            <p>üìÇ Crea una <strong>sottocategoria</strong> all'interno di una categoria esistente</p>
                            <small>Esempio: sotto "maglie toro" ‚Üí "maglie toro vintage", "maglie toro match worn"</small>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-column">
                                <label for="categoria_principale">Categoria principale (dove creare la sottocategoria):</label>
                                <select id="categoria_principale" name="categoria_principale" class="full-width" disabled>
                                    <option value="">-- Seleziona categoria padre --</option>
                                    {% set categorie_principali_uniche = [] %}
                                    {% for categoria in categorie %}
                                        {% if '/' in categoria %}
                                            {% set cat_princ = categoria.split('/')[0].strip() %}
                                            {% if cat_princ not in categorie_principali_uniche %}
                                                {% set _ = categorie_principali_uniche.append(cat_princ) %}
                                            {% endif %}
                                        {% elif '>' in categoria %}
                                            {% set cat_princ = categoria.split('>')[0].strip() %}
                                            {% if cat_princ not in categorie_principali_uniche %}
                                                {% set _ = categorie_principali_uniche.append(cat_princ) %}
                                            {% endif %}
                                        {% else %}
                                            {% if categoria not in categorie_principali_uniche %}
                                                {% set _ = categorie_principali_uniche.append(categoria) %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% for cat_princ in categorie_principali_uniche|sort %}
                                        <option value="{{ cat_princ }}">üìÅ {{ cat_princ }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="form-column">
                                <label for="tipo_separatore">Tipo di separatore:</label>
                                <select id="tipo_separatore" name="tipo_separatore" class="full-width" disabled>
                                    <option value="/">/ (slash) - Raccomandato</option>
                                    <option value=">">‚Üí (freccia) - Alternativo</option>
                                </select>
                            </div>
                        </div>
                        
                        <label for="nuova_sottocategoria">Nome della sottocategoria:</label>
                        <input type="text" 
                               id="nuova_sottocategoria" 
                               name="nuova_sottocategoria" 
                               placeholder="Es: vintage, match worn, firmate, autografate" 
                               class="full-width" 
                               disabled>
                        
                        <div class="preview-box" id="preview-sotto" style="display:none;">
                            <strong>üèóÔ∏è Anteprima categoria completa:</strong>
                            <div class="category-preview">
                                <span id="preview-sotto-text"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- FINE SEZIONE CATEGORIE MIGLIORATA -->

            <div class="form-group">
                <label for="file">Seleziona foto:</label>
                <input type="file" id="file" name="file[]" multiple accept="image/*">
                <div class="preview-container" id="preview"></div>
            </div>

            <div class="form-group">
                <button type="submit" class="btn">Carica foto</button>
            </div>
        </form>
    </main>

    <footer>
        <p>&copy; 2025 Powerded by Fabry FVCG</p>
    </footer>

    <!-- CSS AGGIUNTIVO -->
    <style>
    .category-selection-tabs {
        background-color: #f9f9f9;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 15px;
        border: 1px solid #e0e0e0;
    }

    .tab-buttons {
        display: flex;
        background-color: #eee;
        border-bottom: 1px solid #ddd;
    }

    .tab-btn {
        flex: 1;
        padding: 12px 10px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
        text-align: center;
    }

    .tab-btn:hover {
        background-color: #e0e0e0;
    }

    .tab-btn.active {
        background-color: #750000;
        color: white;
    }

    .tab-content {
        display: none;
        padding: 20px;
    }

    .tab-content.active {
        display: block;
    }

    .explanation-box {
        background-color: #e8f4f8;
        border-left: 4px solid #3498db;
        padding: 12px 15px;
        margin-bottom: 15px;
        border-radius: 0 5px 5px 0;
    }

    .explanation-box p {
        margin: 0 0 5px 0;
        font-weight: 500;
    }

    .explanation-box small {
        color: #666;
        font-style: italic;
    }

    .preview-box {
        background-color: #f0f8f0;
        border: 1px solid #28a745;
        padding: 10px 15px;
        margin-top: 15px;
        border-radius: 5px;
    }

    .category-preview {
        background-color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 1.1rem;
        color: #750000;
        font-weight: bold;
        margin-top: 5px;
    }

    .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-column {
        flex: 1;
    }

    .full-width {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }

    /* Stili per le opzioni del select */
    optgroup {
        font-weight: bold;
        color: #750000;
    }

    option {
        padding: 5px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .tab-buttons {
            flex-direction: column;
        }
        
        .tab-btn {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .form-row {
            flex-direction: column;
            gap: 10px;
        }
    }
    </style>

    <!-- JAVASCRIPT -->
    <script>
        // Anteprima delle immagini selezionate (codice esistente)
        document.getElementById('file').addEventListener('change', function(e) {
            const preview = document.getElementById('preview');
            preview.innerHTML = '';
            
            for (const file of this.files) {
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.classList.add('preview-image');
                    img.file = file;
                    preview.appendChild(img);
                    
                    const reader = new FileReader();
                    reader.onload = (function(aImg) { 
                        return function(e) { 
                            aImg.src = e.target.result; 
                        }; 
                    })(img);
                    reader.readAsDataURL(file);
                }
            }
        });

        // NUOVO CODICE PER I TAB DELLE CATEGORIE
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Gestione dei tab
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Rimuovi active da tutti
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        // Disabilita tutti i campi
                        content.querySelectorAll('input, select').forEach(field => {
                            field.disabled = true;
                        });
                    });

                    // Attiva il tab selezionato
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    const activeContent = document.getElementById(tabId);
                    activeContent.classList.add('active');
                    
                    // Abilita i campi del tab attivo
                    activeContent.querySelectorAll('input, select').forEach(field => {
                        field.disabled = false;
                    });
                });
            });
            
            // Anteprima per categoria principale
            const nuovaPrincipaleInput = document.getElementById('nuova_categoria_principale');
            const previewPrincipale = document.getElementById('preview-principale');
            const previewPrincipaleText = document.getElementById('preview-principale-text');
            
            nuovaPrincipaleInput?.addEventListener('input', function() {
                const valore = this.value.trim();
                if (valore) {
                    previewPrincipaleText.textContent = valore;
                    previewPrincipale.style.display = 'block';
                } else {
                    previewPrincipale.style.display = 'none';
                }
            });
            
            // Anteprima per sottocategoria
            const categoriaPrincipaleSelect = document.getElementById('categoria_principale');
            const tipoSeparatoreSelect = document.getElementById('tipo_separatore');
            const nuovaSottocategoriaInput = document.getElementById('nuova_sottocategoria');
            const previewSotto = document.getElementById('preview-sotto');
            const previewSottoText = document.getElementById('preview-sotto-text');
            
            function aggiornaPreviewSotto() {
                const principale = categoriaPrincipaleSelect?.value || '';
                const separatore = tipoSeparatoreSelect?.value || '/';
                const sottocategoria = nuovaSottocategoriaInput?.value.trim() || '';
                
                if (principale && sottocategoria) {
                    const categoriaCompleta = `${principale}${separatore}${sottocategoria}`;
                    previewSottoText.textContent = categoriaCompleta;
                    previewSotto.style.display = 'block';
                } else {
                    previewSotto.style.display = 'none';
                }
            }
            
            categoriaPrincipaleSelect?.addEventListener('change', aggiornaPreviewSotto);
            tipoSeparatoreSelect?.addEventListener('change', aggiornaPreviewSotto);
            nuovaSottocategoriaInput?.addEventListener('input', aggiornaPreviewSotto);
            
            // Inizializza il primo tab
            document.querySelector('.tab-btn.active')?.click();
        });
    </script>
</body>
</html>